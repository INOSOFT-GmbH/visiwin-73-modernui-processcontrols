name: 'Build and Package NuGet'

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'VisiWin7.ProcessControls.WPF/**'
      - 'VisiWin7.ProcessControls.Styles.WPF/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'VisiWin7.ProcessControls.WPF/**'
      - 'VisiWin7.ProcessControls.Styles.WPF/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (e.g., 1.0.1)'
        required: false
        default: ''
      create_release:
        description: 'Create GitHub release'
        required: false
        default: false
        type: boolean

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  BUILD_CONFIGURATION: Release

jobs:
  build-and-package:
    runs-on: windows-latest
    
    strategy:
      matrix:
        project: 
          - name: 'VisiWin7.ProcessControls.WPF'
            path: 'VisiWin7.ProcessControls.WPF/VisiWin7.ProcessControls.WPF.csproj'
            dir: 'VisiWin7.ProcessControls.WPF'
          - name: 'VisiWin7.ProcessControls.Styles.WPF'
            path: 'VisiWin7.ProcessControls.Styles.WPF/VisiWin7.ProcessControls.Styles.WPF.csproj'
            dir: 'VisiWin7.ProcessControls.Styles.WPF'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
      with:
        nuget-version: 'latest'

    - name: Restore dependencies
      run: |
        nuget restore VisiWin7.ProcessControls.sln

    - name: Set package version
      if: github.event.inputs.version != ''
      shell: powershell
      run: |
        $version = "${{ github.event.inputs.version }}"
        $projectFile = "${{ matrix.project.path }}"
        
        # Update .csproj version
        $content = Get-Content $projectFile -Raw
        if ($content -match '<PackageVersion>.*?</PackageVersion>') {
          $content = $content -replace '<PackageVersion>.*?</PackageVersion>', "<PackageVersion>$version</PackageVersion>"
        } else {
          # Add PackageVersion if it doesn't exist
          $content = $content -replace '(<PropertyGroup[^>]*>)', "`$1`n    <PackageVersion>$version</PackageVersion>"
        }
        Set-Content $projectFile $content
        
        # Update .nuspec version if exists
        $nuspecFile = $projectFile -replace '\.csproj$', '.nuspec'
        if (Test-Path $nuspecFile) {
          $nuspecContent = Get-Content $nuspecFile -Raw
          $nuspecContent = $nuspecContent -replace '<version>.*?</version>', "<version>$version</version>"
          Set-Content $nuspecFile $nuspecContent
        }

    - name: Build solution
      run: |
        msbuild VisiWin7.ProcessControls.sln /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform="Any CPU" /p:RestorePackages=false

    - name: Create NuGet package for ${{ matrix.project.name }}
      shell: powershell
      run: |
        $projectPath = "${{ matrix.project.path }}"
        $projectDir = Split-Path $projectPath
        $projectName = "${{ matrix.project.name }}"
        
        Push-Location $projectDir
        
        # Check if .nuspec file exists
        $nuspecFile = "$projectName.nuspec"
        if (Test-Path $nuspecFile) {
          Write-Host "Creating package using .nuspec file..."
          nuget pack $nuspecFile -OutputDirectory "bin\${{ env.BUILD_CONFIGURATION }}"
        } else {
          Write-Host "Creating package from .csproj file..."
          nuget pack "$projectName.csproj" -Properties Configuration=${{ env.BUILD_CONFIGURATION }} -OutputDirectory "bin\${{ env.BUILD_CONFIGURATION }}"
        }
        
        Pop-Location

    - name: Upload NuGet packages as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages-${{ matrix.project.name }}
        path: |
          ${{ matrix.project.dir }}/bin/${{ env.BUILD_CONFIGURATION }}/*.nupkg
        retention-days: 30

    - name: Validate NuGet package
      shell: powershell
      run: |
        $projectDir = Split-Path "${{ matrix.project.path }}"
        $nupkgFiles = Get-ChildItem "$projectDir\bin\${{ env.BUILD_CONFIGURATION }}\*.nupkg"
        
        foreach ($nupkg in $nupkgFiles) {
          Write-Host "Validating package: $($nupkg.Name)"
          
          # Check package size
          $sizeKB = [math]::Round($nupkg.Length / 1KB, 2)
          Write-Host "Package size: $sizeKB KB"
          
          if ($nupkg.Length -lt 1KB) {
            Write-Error "Package $($nupkg.Name) is too small (less than 1KB)"
            exit 1
          }
          
          # Verify package contents using nuget.exe
          Write-Host "Package contents:"
          nuget list $nupkg.BaseName -Source $nupkg.DirectoryName -AllVersions
        }

  publish-packages:
    needs: build-and-package
    runs-on: windows-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: packages

    - name: Setup NuGet
      uses: nuget/setup-nuget@v2
      with:
        nuget-version: 'latest'

    - name: Publish to GitHub Packages
      shell: powershell
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Configure GitHub Packages source
        $source = "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        nuget sources add -Name "github" -Source $source -Username ${{ github.repository_owner }} -Password $env:GITHUB_TOKEN -StorePasswordInClearText
        
        # Find and push all .nupkg files
        $packages = Get-ChildItem "packages" -Filter "*.nupkg" -Recurse
        
        foreach ($package in $packages) {
          Write-Host "Publishing package: $($package.Name)"
          try {
            nuget push $package.FullName -Source "github" -ApiKey $env:GITHUB_TOKEN -SkipDuplicate
            Write-Host "Successfully published $($package.Name)"
          }
          catch {
            Write-Warning "Failed to publish $($package.Name): $($_.Exception.Message)"
          }
        }

    # Uncomment this section if you want to publish to NuGet.org
    # - name: Publish to NuGet.org
    #   if: env.NUGET_API_KEY != ''
    #   shell: powershell
    #   env:
    #     NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
    #   run: |
    #     $packages = Get-ChildItem "packages" -Filter "*.nupkg" -Recurse
    #     
    #     foreach ($package in $packages) {
    #       Write-Host "Publishing package to NuGet.org: $($package.Name)"
    #       try {
    #         nuget push $package.FullName -Source https://api.nuget.org/v3/index.json -ApiKey $env:NUGET_API_KEY -SkipDuplicate
    #         Write-Host "Successfully published $($package.Name) to NuGet.org"
    #       }
    #       catch {
    #         Write-Warning "Failed to publish $($package.Name) to NuGet.org: $($_.Exception.Message)"
    #       }
    #     }

  create-release:
    needs: [build-and-package, publish-packages]
    runs-on: windows-latest
    if: github.event.inputs.create_release == 'true' && github.event.inputs.version != ''
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: packages

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: Release v${{ github.event.inputs.version }}
        body: |
          ## VisiWin7 Process Controls Release v${{ github.event.inputs.version }}
          
          ### ðŸ“¦ NuGet Packages
          - VisiWin7.ProcessControls.WPF v${{ github.event.inputs.version }}
          - VisiWin7.ProcessControls.Styles.WPF v${{ github.event.inputs.version }}
          
          ### ðŸš€ Features
          - WPF Process Controls for industrial applications
          - Comprehensive style library
          - .NET Framework 4.8 support
          
          ### ðŸ“¥ Installation
          ```
          Install-Package VisiWin7.ProcessControls.WPF -Version ${{ github.event.inputs.version }}
          Install-Package VisiWin7.ProcessControls.Styles.WPF -Version ${{ github.event.inputs.version }}
          ```
        files: |
          packages/**/*.nupkg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}